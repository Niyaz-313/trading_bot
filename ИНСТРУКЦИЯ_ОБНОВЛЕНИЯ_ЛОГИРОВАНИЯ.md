# ИНСТРУКЦИЯ: Обновление логирования на сервере

## Изменённые файлы:
1. `tinvest_api.py` - улучшено логирование ошибок размещения ордеров
2. `broker_api.py` - передача деталей ошибок
3. `main.py` - детальное логирование для всех типов ордеров + проверка торговой сессии

## Шаги для обновления:

### 1. На локальном ПК (Windows):
```batch
cd "C:\Users\karim\OneDrive\Рабочий стол\Bot"
sync_to_server.bat
```

Или вручную:
```batch
git add tinvest_api.py broker_api.py main.py
git commit -m "Улучшено логирование причин отказа размещения ордеров + проверка торговой сессии"
git pull origin main
git push origin main
```

### 2. На сервере (Linux):
```bash
cd /home/botuser/trading_bot/trading_bot
./server_update.sh
```

Или вручную:
```bash
cd /home/botuser/trading_bot/trading_bot
git stash push -m "Server logs before pull" audit_logs/ logs/
git pull origin main
git stash pop
sudo systemctl restart trading-bot.service
```

### 3. Проверка работы:
```bash
# Проверить логи на ошибки
tail -100 logs/trading_bot.log | grep -i "error\|ошибка"

# Проверить, что бот работает
sudo systemctl status trading-bot.service

# Проверить audit-логи на новые записи
tail -20 audit_logs/trades_audit.jsonl | grep "order_placement_failed"
```

## Что изменилось:

### Улучшенное логирование:
- ✅ Детальная информация об ошибках (код, тип, описание)
- ✅ Параметры ордера (qty, lot, figi, price)
- ✅ Время для ошибок вне торговой сессии
- ✅ Рекомендации по устранению проблемы

### Проверка торговой сессии:
- ✅ Автоматическая проверка времени работы MOEX (10:00-18:45 MSK, пн-пт)
- ✅ Пропуск ордеров вне торговой сессии с логированием

### Audit-логи:
- ✅ Детальная информация об ошибках в `details`
- ✅ Причина отказа (`reason`)
- ✅ Код ошибки API (`error_code`)




