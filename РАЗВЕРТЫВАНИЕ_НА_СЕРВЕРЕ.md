# РАЗВЕРТЫВАНИЕ БОТА НА УДАЛЕННОМ СЕРВЕРЕ

## Цель
Запустить бота на удаленном сервере 24/7 с синхронизацией кода с локальной машины.

## Архитектура решения

```
Локальный компьютер (разработка)
    ↓ (синхронизация через Git/rsync)
Удаленный сервер (продакшн)
    ↓ (запуск через systemd/supervisor)
Бот работает 24/7
```

---

## ЭТАП 1: ВЫБОР И НАСТРОЙКА СЕРВЕРА

### 1.1. Выбор VPS провайдера

**Рекомендуемые варианты:**
- **Timeweb Cloud** (Россия) - от 200₽/мес
- **Selectel** (Россия) - от 300₽/мес
- **DigitalOcean** (международный) - от $6/мес
- **Hetzner** (Германия) - от €4/мес
- **AWS Lightsail** (международный) - от $5/мес

**Минимальные требования:**
- CPU: 1-2 ядра
- RAM: 1-2 GB
- Диск: 20-40 GB SSD
- ОС: Ubuntu 22.04 LTS или Debian 12
- Сеть: стабильное подключение

### 1.2. Первоначальная настройка сервера

```bash
# 1. Подключитесь к серверу по SSH
ssh root@ваш_сервер_ip

# 2. Обновите систему
apt update && apt upgrade -y

# 3. Создайте пользователя для бота (не root!)
adduser botuser
usermod -aG sudo botuser

# 4. Настройте SSH ключи (для безопасного доступа)
# На локальной машине (Windows PowerShell или Git Bash):
ssh-keygen -t ed25519 -C "bot_deployment"
# Скопируйте публичный ключ на сервер:
type $env:USERPROFILE\.ssh\id_ed25519.pub | ssh botuser@ваш_сервер_ip "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

# 5. Отключите вход по паролю (опционально, для безопасности)
# На сервере в /etc/ssh/sshd_config:
# PasswordAuthentication no
# Затем: sudo systemctl restart sshd
```

---

## ЭТАП 2: УСТАНОВКА ЗАВИСИМОСТЕЙ НА СЕРВЕРЕ

### 2.1. Установка Python и системных пакетов

```bash
# Подключитесь как botuser
ssh botuser@ваш_сервер_ip

# Установите Python 3.11+ и необходимые пакеты
sudo apt install -y python3.11 python3.11-venv python3-pip git curl

# Установите дополнительные зависимости
sudo apt install -y build-essential libssl-dev libffi-dev python3-dev
```

### 2.2. Создание рабочей директории

```bash
# Создайте директорию для бота
mkdir -p ~/trading_bot
cd ~/trading_bot
```

---

## ЭТАП 3: СИНХРОНИЗАЦИЯ КОДА

### Вариант A: Через Git (рекомендуется)

#### 3.1. На локальной машине

```bash
# 1. Инициализируйте Git репозиторий (если еще не сделано)
cd "C:\Users\karim\OneDrive\Рабочий стол\Bot"
git init

# 2. Создайте .gitignore (если нет)
# Убедитесь, что в .gitignore есть:
# .env
# *.log
# __pycache__/
# audit_logs/
# data_cache/
# state/

# 3. Создайте репозиторий на GitHub/GitLab (или используйте приватный)
# На GitHub: создайте новый приватный репозиторий

# 4. Добавьте файлы и закоммитьте
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/ваш_username/trading_bot.git
git push -u origin main
```

#### 3.2. На сервере

```bash
# 1. Клонируйте репозиторий
cd ~/trading_bot
git clone https://github.com/ваш_username/trading_bot.git .

# 2. Создайте виртуальное окружение
python3.11 -m venv venv
source venv/bin/activate

# 3. Установите зависимости
pip install --upgrade pip
pip install -r requirements.txt
```

### Вариант B: Через rsync (альтернатива)

#### 3.1. Настройка на локальной машине (Windows)

**Используйте WSL или Git Bash:**

```bash
# Через WSL
wsl rsync -avz --exclude='.env' --exclude='*.log' --exclude='__pycache__' \
  --exclude='audit_logs' --exclude='data_cache' --exclude='state' \
  /mnt/c/Users/karim/OneDrive/Рабочий\ стол/Bot/ \
  botuser@ваш_сервер_ip:~/trading_bot/
```

---

## ЭТАП 4: НАСТРОЙКА ОКРУЖЕНИЯ НА СЕРВЕРЕ

### 4.1. Создание .env файла на сервере

```bash
# На сервере
cd ~/trading_bot
nano .env

# Скопируйте содержимое вашего .env файла с локальной машины
# ВАЖНО: Не коммитьте .env в Git!
```

**Или скопируйте через SCP:**

```bash
# На локальной машине (PowerShell или Git Bash)
scp "C:\Users\karim\OneDrive\Рабочий стол\Bot\.env" botuser@ваш_сервер_ip:~/trading_bot/.env
```

### 4.2. Проверка подключений

```bash
# На сервере
cd ~/trading_bot
source venv/bin/activate

# Проверьте подключение к T-Invest API
python3 -c "from broker_api import BrokerAPI; b = BrokerAPI(paper_trading=True); print('OK' if b.client else 'FAIL')"

# Проверьте Telegram бота
python3 -c "from telegram_bot import TelegramBot; t = TelegramBot(); print('OK')"
```

---

## ЭТАП 5: ЗАПУСК БОТА КАК СЕРВИСА

### Вариант A: Systemd (рекомендуется для Linux)

#### 5.1. Создание systemd сервиса

```bash
# На сервере
sudo nano /etc/systemd/system/trading-bot.service
```

**Содержимое файла:**

```ini
[Unit]
Description=Trading Bot Service
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/home/botuser/trading_bot
Environment="PATH=/home/botuser/trading_bot/venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/botuser/trading_bot/venv/bin/python /home/botuser/trading_bot/main.py
Restart=always
RestartSec=10
StandardOutput=append:/home/botuser/trading_bot/logs/bot_output.log
StandardError=append:/home/botuser/trading_bot/logs/bot_error.log

[Install]
WantedBy=multi-user.target
```

#### 5.2. Активация и запуск сервиса

```bash
# Создайте директорию для логов
mkdir -p ~/trading_bot/logs

# Перезагрузите systemd
sudo systemctl daemon-reload

# Включите автозапуск
sudo systemctl enable trading-bot.service

# Запустите сервис
sudo systemctl start trading-bot.service

# Проверьте статус
sudo systemctl status trading-bot.service

# Просмотр логов
sudo journalctl -u trading-bot.service -f
```

### Вариант B: Supervisor (альтернатива)

#### 5.1. Установка Supervisor

```bash
sudo apt install -y supervisor
```

#### 5.2. Создание конфигурации

```bash
sudo nano /etc/supervisor/conf.d/trading-bot.conf
```

**Содержимое:**

```ini
[program:trading-bot]
command=/home/botuser/trading_bot/venv/bin/python /home/botuser/trading_bot/main.py
directory=/home/botuser/trading_bot
user=botuser
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/home/botuser/trading_bot/logs/bot_output.log
stderr_logfile=/home/botuser/trading_bot/logs/bot_error.log
```

#### 5.3. Запуск

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start trading-bot
sudo supervisorctl status
```

### Вариант C: Screen/Tmux (простой вариант)

```bash
# Установите screen
sudo apt install -y screen

# Создайте сессию
screen -S trading_bot

# Активируйте виртуальное окружение и запустите бота
cd ~/trading_bot
source venv/bin/activate
python main.py

# Отключитесь: Ctrl+A, затем D
# Подключитесь обратно: screen -r trading_bot
```

---

## ЭТАП 6: АВТОМАТИЧЕСКАЯ СИНХРОНИЗАЦИЯ КОДА

### 6.1. Скрипт синхронизации на локальной машине

**Используйте готовый скрипт `sync_to_server.bat` (см. ниже)**

### 6.2. Скрипт обновления на сервере

**Создайте файл `~/trading_bot/update.sh` на сервере:**

```bash
#!/bin/bash
cd ~/trading_bot

# Активировать виртуальное окружение
source venv/bin/activate

# Обновить код из Git
git pull origin main

# Обновить зависимости (если requirements.txt изменился)
pip install -r requirements.txt

# Перезапустить сервис
sudo systemctl restart trading-bot.service

echo "Бот обновлен и перезапущен"
```

**Сделайте исполняемым:**
```bash
chmod +x ~/trading_bot/update.sh
```

### 6.3. Автоматическая синхронизация через cron (на сервере)

```bash
# На сервере: обновление каждые 6 часов
crontab -e

# Добавьте строку:
0 */6 * * * cd /home/botuser/trading_bot && /home/botuser/trading_bot/update.sh >> /home/botuser/trading_bot/logs/update.log 2>&1
```

---

## ЭТАП 7: МОНИТОРИНГ И ЛОГИРОВАНИЕ

### 7.1. Настройка логирования

**Убедитесь, что в `config.py` настроены пути к логам:**

```python
LOG_FILE = 'logs/trading_bot.log'
AUDIT_LOG_PATH = 'audit_logs/trades_audit.jsonl'
```

### 7.2. Мониторинг через Telegram

Бот уже отправляет уведомления в Telegram. Убедитесь, что:
- `TELEGRAM_BOT_TOKEN` настроен
- `TELEGRAM_CHAT_ID` настроен

### 7.3. Мониторинг сервера

**Установите утилиты мониторинга:**

```bash
# htop для мониторинга ресурсов
sudo apt install -y htop

# netdata для веб-мониторинга (опционально)
bash <(curl -Ss https://my-netdata.io/kickstart.sh)
```

---

## ЭТАП 8: РЕЗЕРВНОЕ КОПИРОВАНИЕ

### 8.1. Автоматическое резервное копирование на локальную машину

**Используйте готовый скрипт `backup_from_server.bat` (см. ниже)**

### 8.2. Автоматическое резервное копирование на сервере

**Создайте скрипт `~/trading_bot/backup.sh`:**

```bash
#!/bin/bash
BACKUP_DIR=~/backups/trading_bot
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Резервная копия важных данных
tar -czf $BACKUP_DIR/audit_$DATE.tar.gz audit_logs/
tar -czf $BACKUP_DIR/state_$DATE.tar.gz state/

# Удалить старые бэкапы (старше 30 дней)
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Резервное копирование завершено: $DATE"
```

**Сделайте исполняемым:**
```bash
chmod +x ~/trading_bot/backup.sh
```

**Добавьте в cron:**
```bash
crontab -e
# Ежедневное резервное копирование в 3:00
0 3 * * * /home/botuser/trading_bot/backup.sh >> /home/botuser/trading_bot/logs/backup.log 2>&1
```

---

## ЭТАП 9: БЕЗОПАСНОСТЬ

### 9.1. Настройка файрвола

```bash
# Установите ufw
sudo apt install -y ufw

# Разрешите SSH
sudo ufw allow 22/tcp

# Разрешите только необходимые порты
# (для бота обычно не нужны открытые порты, только исходящие соединения)

# Включите файрвол
sudo ufw enable
sudo ufw status
```

### 9.2. Защита .env файла

```bash
# Убедитесь, что .env не доступен для чтения другими пользователями
chmod 600 ~/trading_bot/.env

# Не коммитьте .env в Git (уже должно быть в .gitignore)
```

### 9.3. Регулярные обновления

```bash
# Настройте автоматические обновления безопасности
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

## ЭТАП 10: РАБОЧИЙ ПРОЦЕСС РАЗРАБОТКИ

### 10.1. Разработка на локальной машине

1. Вносите изменения в код на локальной машине
2. Тестируйте локально (в песочнице)
3. Коммитьте изменения в Git
4. Запускайте `sync_to_server.bat` для синхронизации

### 10.2. Обновление на сервере

**Вариант 1: Автоматически (через cron)**
- Сервер автоматически обновляется каждые 6 часов

**Вариант 2: Вручную**
```bash
# На сервере
ssh botuser@ваш_сервер_ip
cd ~/trading_bot
./update.sh
```

### 10.3. Просмотр логов

```bash
# На сервере
# Systemd
sudo journalctl -u trading-bot.service -f

# Или напрямую
tail -f ~/trading_bot/logs/trading_bot.log
tail -f ~/trading_bot/audit_logs/trades_audit.jsonl
```

---

## ЭТАП 11: ПРОВЕРКА РАБОТОСПОСОБНОСТИ

### 11.1. Проверка статуса сервиса

```bash
# На сервере
sudo systemctl status trading-bot.service

# Должно быть: active (running)
```

### 11.2. Проверка логов

```bash
# Проверьте последние записи
tail -n 50 ~/trading_bot/logs/trading_bot.log

# Проверьте ошибки
grep -i error ~/trading_bot/logs/trading_bot.log | tail -20
```

### 11.3. Проверка через Telegram

- Отправьте команду `/status` боту в Telegram
- Проверьте, что бот отвечает

---

## ЧЕКЛИСТ РАЗВЕРТЫВАНИЯ

- [ ] Выбран и настроен VPS сервер
- [ ] Установлен Python и зависимости
- [ ] Код синхронизирован через Git или rsync
- [ ] Создан .env файл на сервере
- [ ] Бот запущен как systemd сервис
- [ ] Настроена автоматическая синхронизация
- [ ] Настроено резервное копирование
- [ ] Настроен файрвол
- [ ] Проверена работоспособность
- [ ] Настроен мониторинг

---

## РЕШЕНИЕ ПРОБЛЕМ

### Бот не запускается

```bash
# Проверьте логи
sudo journalctl -u trading-bot.service -n 50

# Проверьте права доступа
ls -la ~/trading_bot/.env

# Проверьте виртуальное окружение
source ~/trading_bot/venv/bin/activate
python --version
```

### Бот падает

```bash
# Проверьте логи ошибок
tail -f ~/trading_bot/logs/bot_error.log

# Проверьте использование ресурсов
htop

# Проверьте подключение к API
curl -I https://api-invest.tinkoff.ru
```

### Проблемы с синхронизацией

```bash
# Проверьте Git статус
cd ~/trading_bot
git status

# Принудительное обновление
git fetch origin
git reset --hard origin/main
```

---

## ДОПОЛНИТЕЛЬНЫЕ РЕКОМЕНДАЦИИ

1. **Используйте Git для версионирования** - это самый надежный способ синхронизации
2. **Регулярно делайте бэкапы** - особенно audit_logs и state
3. **Мониторьте ресурсы сервера** - следите за использованием CPU/RAM
4. **Настройте алерты** - получайте уведомления о проблемах через Telegram
5. **Документируйте изменения** - ведите changelog для отслеживания изменений

---

## КОНТАКТЫ И ПОДДЕРЖКА

При возникновении проблем:
1. Проверьте логи на сервере
2. Проверьте статус сервиса
3. Проверьте подключение к API и Telegram
4. При необходимости перезапустите сервис
