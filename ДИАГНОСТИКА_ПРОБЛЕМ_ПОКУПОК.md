# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú –° –†–ê–ó–ú–ï–©–ï–ù–ò–ï–ú –ó–ê–Ø–í–û–ö –ù–ê –ü–û–ö–£–ü–ö–£

**–î–∞—Ç–∞:** 2026-01-16  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –Ω–µ —Ä–∞–∑–º–µ—â–∞–µ—Ç –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–∫—É–ø–∫—É

---

## üìä –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í –ò AUDIT

### **1. –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –û–®–ò–ë–ö–ò:**

#### A. ‚ùå **–¢–ò–•–ò–ï –û–¢–ö–ê–ó–´ –ü–†–ò –û–®–ò–ë–ö–ê–• –†–ê–ó–ú–ï–©–ï–ù–ò–Ø –ó–ê–Ø–í–û–ö**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í `main.py` —Å—Ç—Ä–æ–∫–∞ 875-877:
```python
order = self.broker.place_market_order(symbol, qty_lots, 'buy')
if not order:
    return  # ‚ùå –ë–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ï—Å–ª–∏ `place_market_order` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–ø—Ä–∏ –æ—à–∏–±–∫–µ), —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è
- –ù–µ—Ç –∞—É–¥–∏—Ç–∞ –æ —Ç–æ–º, —á—Ç–æ –∑–∞—è–≤–∫–∞ –Ω–µ –±—ã–ª–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∞
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç —Å–æ–±—ã—Ç–∏—è

---

#### B. ‚ùå **–û–®–ò–ë–ö–ê: "NoneType' object is not iterable"**

**–õ–æ–≥ (—Å—Ç—Ä–æ–∫–∞ 2463, 2474):**
```
2026-01-04 02:38:05,950 - __main__ - ERROR - –û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: 'NoneType' object is not iterable
TypeError: 'NoneType' object is not iterable
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- `get_positions()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` –≤–º–µ—Å—Ç–æ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞
- –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ `None` –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Ç–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º API

---

#### C. ‚ùå **–û–®–ò–ë–ö–ê: "datetime.datetime' object has no attribute 'to_pydatetime'"**

**–õ–æ–≥ (—Å—Ç—Ä–æ–∫–∞ 3057):**
```
2026-01-04 03:13:20,323 - tinvest_api - ERROR - –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π: 'datetime.datetime' object has no attribute 'to_pydatetime'
AttributeError: 'datetime.datetime' object has no attribute 'to_pydatetime'
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- Pandas datetime —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è `datetime.datetime` –≤ Python 3.12+
- –í—ã–∑–æ–≤ `.to_pydatetime()` –Ω–∞ –æ–±—ã—á–Ω–æ–º datetime –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É datetime –≤ `tinvest_api.py`

---

#### D. ‚ö†Ô∏è **"Cannot invoke RPC on closed channel"**

**–õ–æ–≥ (—Å—Ç—Ä–æ–∫–∏ 10, 127):**
```
ERROR - –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π: Cannot invoke RPC on closed channel!
ValueError: Cannot invoke RPC on closed channel!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- gRPC –∫–∞–Ω–∞–ª –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ß–∞—Å—Ç–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏**

–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `main.py` `_execute_buy()`:

```python
order = self.broker.place_market_order(symbol, qty_lots, 'buy')
if not order:
    # –ö–†–ò–¢–ò–ß–ù–û: –õ–æ–≥–∏—Ä—É–µ–º –ø–æ—á–µ–º—É –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞—è–≤–∫—É
    logger.error(f"‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –†–ê–ó–ú–ï–°–¢–ò–¢–¨ –ó–ê–Ø–í–ö–£: {symbol}, qty={qty_lots}, reason=place_market_order –≤–µ—Ä–Ω—É–ª None")
    self._audit_event({
        "event": "skip",
        "symbol": symbol,
        "skip_reason": "order_placement_failed",
        "price": float(current_price),
        "confidence": float(analysis.get("confidence", 0) or 0),
        "details": {
            "reason": "place_market_order returned None",
            "qty_lots": int(qty_lots),
            "rank": int(rank),
            "score": float(score),
        },
    })
    return
```

---

### **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2: –ó–∞—â–∏—Ç–∞ –æ—Ç None –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏**

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç `get_positions()`:

```python
# –í main.py —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ–≥–¥–∞ —Å–ø–∏—Å–æ–∫:
positions = self.broker.get_positions() or []  # ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç None
```

---

### **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ datetime.to_pydatetime()**

–í `tinvest_api.py` –Ω–∞–π—Ç–∏ –º–µ—Å—Ç–∞ –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `.to_pydatetime()` –∏ –∑–∞–º–µ–Ω–∏—Ç—å:

```python
# –ë–´–õ–û:
if hasattr(dt, 'to_pydatetime'):
    dt = dt.to_pydatetime()

# –°–¢–ê–õ–û:
if hasattr(dt, 'to_pydatetime'):
    try:
        dt = dt.to_pydatetime()
    except AttributeError:
        # –£–∂–µ datetime, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        pass
```

---

## üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç)

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç `check_buy_signals.py` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
- –°–∫–æ–ª—å–∫–æ decision —Å–æ–±—ã—Ç–∏–π
- –°–∫–æ–ª—å–∫–æ —Å strategy_should_buy=true
- –°–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã—Ö BUY —Å–¥–µ–ª–æ–∫
- –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∞

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

- [ ] 1. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `_execute_buy()` –ø—Ä–∏ `order is None`
- [ ] 2. –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏
- [ ] 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç None –≤ `get_positions()` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- [ ] 4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å `.to_pydatetime()` –≤ `tinvest_api.py`
- [ ] 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å `check_buy_signals.py` –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- [ ] 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
1. ‚úÖ –í—Å–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –±—É–¥—É—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
2. ‚úÖ –ü–æ—è–≤–∏—Ç—Å—è –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –ø–æ—á–µ–º—É –∑–∞—è–≤–∫–∏ –Ω–µ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è
3. ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –æ—à–∏–±–∫–∏ TypeError –∏ AttributeError
4. ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏





