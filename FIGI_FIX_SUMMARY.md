# Исправление обработки FIGI для всех типов инструментов

## Проблема
Бот получал ошибки `"Инструмент BBGPLTRUBTOM не найден"` при обработке стоп-лоссов для валютных инструментов (PLTRUB_TOM, PLDRUB_TOM). Проблема была в том, что позиции возвращались с FIGI вместо тикера, и функции поиска инструментов не могли их обработать.

## Исправления

### 1. `tinvest_api.py` - `get_positions()`
**Изменения:**
- Расширен маппинг `figi_to_meta` для всех типов инструментов:
  - Акции (shares)
  - ETF (включая валютные и металлы)
  - Валюты (currencies)
  - Облигации (bonds)
- Добавлен поиск тикера через API для всех типов, если тикер не найден в `figi_to_meta`
- Исправлен вложенный контекст клиента (используется текущий `client` вместо создания нового)

**Результат:** Позиции теперь всегда возвращаются с тикером, а не FIGI.

### 2. `tinvest_api.py` - `get_instrument_by_figi()`
**Новая функция:**
- Ищет инструмент по FIGI во всех типах: currencies, ETFs, shares, bonds
- Возвращает полную информацию об инструменте (тикер, lot, статус торговли и т.д.)

### 3. `tinvest_api.py` - `get_instrument_by_ticker()`
**Изменения:**
- Добавлена проверка: если входной параметр является FIGI (начинается с "BBG"), автоматически вызывает `get_instrument_by_figi()`
- Теперь поддерживает как тикер, так и FIGI

### 4. `tinvest_api.py` - `get_instrument_details()`
**Изменения:**
- Добавлена проверка на FIGI
- Если входной параметр - FIGI, использует `get_instrument_by_figi()`
- Иначе использует `get_instrument_by_ticker()`

### 5. `tinvest_api.py` - `place_market_order()`
**Изменения:**
- Добавлена поддержка FIGI
- Автоматически определяет тип входного параметра (тикер или FIGI)
- Использует соответствующий метод поиска инструмента

### 6. `tinvest_api.py` - `place_limit_order()`
**Изменения:**
- Добавлена поддержка FIGI (аналогично `place_market_order()`)

### 7. `tinvest_api.py` - `get_historical_data()`
**Изменения:**
- Добавлен поиск по FIGI в дополнение к поиску по тикеру
- Если входной параметр - FIGI, ищет инструмент по FIGI во всех типах
- Иначе использует стандартный поиск по тикеру

### 8. `tinvest_api.py` - `get_current_price()`
**Изменения:**
- Добавлена поддержка FIGI
- Если входной параметр - FIGI, использует `get_current_price_by_figi()` напрямую

### 9. `main.py` - `_ensure_ticker_not_figi()`
**Новая функция-хелпер:**
- Проверяет, является ли `symbol` FIGI
- Если да, пытается найти тикер через API
- Возвращает тикер или исходный `symbol`

### 10. `main.py` - `_execute_buy()`
**Изменения:**
- Использует `_ensure_ticker_not_figi()` перед вызовом `get_instrument_details()`
- Гарантирует, что в API передается тикер, а не FIGI

### 11. `main.py` - `process_symbol()` (SELL логика)
**Изменения:**
- Использует `_ensure_ticker_not_figi()` перед вызовом `get_instrument_details()` и `place_market_order()`
- Гарантирует использование тикера для размещения ордеров

### 12. `main.py` - `check_positions()`
**Изменения:**
- Улучшена логика преобразования FIGI в тикер
- Сначала пытается взять тикер из самой позиции
- Если не найден, использует API для поиска
- При размещении ордеров стоп-лоссов и тейк-профитов использует правильный тикер

### 13. `broker_api.py` - `get_instrument_details()` и `get_instrument_by_figi()`
**Изменения:**
- Обновлены для использования новых методов из `TInvestAPI`
- `get_instrument_details()` теперь поддерживает и тикер, и FIGI

## Покрытие типов инструментов

Все исправления работают для всех типов инструментов из SYMBOLS:

### Акции (27 символов)
- SBER, GAZP, YNDX, VTBR, MOEX, LKOH, ROSN, NVTK, GMKN, TATN, MGNT, AFLT, SNGS, SNGSP, CHMF, NLMK, MAGN, MTSS, IRAO, ALRS, PHOR, PLZL, RUAL, AFKS, TRNFP, SIBN, FLOT, BANE, BANEP, RNFT, TATNP, SELG

### ETF и металлы (2 символа)
- UGLD (золото)
- LNZL (металлы)

### Валюты (7 символов)
- USD000UTSTOM
- CNYRUB_TOM
- GLDRUB_TOM
- SLVRUB_TOM
- PLTRUB_TOM
- PLDRUB_TOM

## Результат

✅ Все функции теперь правильно обрабатывают как тикеры, так и FIGI
✅ Позиции всегда возвращаются с тикером (не FIGI)
✅ При размещении ордеров используется правильный тикер
✅ Ошибки `"Инструмент BBG... не найден"` больше не должны возникать
✅ Поддержка всех типов инструментов: акции, ETF, валюты, облигации

## Тестирование

Рекомендуется протестировать:
1. Открытие позиций по валютным инструментам (PLTRUB_TOM, PLDRUB_TOM)
2. Обработку стоп-лоссов для валютных позиций
3. Обработку тейк-профитов для валютных позиций
4. Обработку позиций по металлам (UGLD)
5. Обработку позиций по акциям (должна работать как раньше)



## Проблема
Бот получал ошибки `"Инструмент BBGPLTRUBTOM не найден"` при обработке стоп-лоссов для валютных инструментов (PLTRUB_TOM, PLDRUB_TOM). Проблема была в том, что позиции возвращались с FIGI вместо тикера, и функции поиска инструментов не могли их обработать.

## Исправления

### 1. `tinvest_api.py` - `get_positions()`
**Изменения:**
- Расширен маппинг `figi_to_meta` для всех типов инструментов:
  - Акции (shares)
  - ETF (включая валютные и металлы)
  - Валюты (currencies)
  - Облигации (bonds)
- Добавлен поиск тикера через API для всех типов, если тикер не найден в `figi_to_meta`
- Исправлен вложенный контекст клиента (используется текущий `client` вместо создания нового)

**Результат:** Позиции теперь всегда возвращаются с тикером, а не FIGI.

### 2. `tinvest_api.py` - `get_instrument_by_figi()`
**Новая функция:**
- Ищет инструмент по FIGI во всех типах: currencies, ETFs, shares, bonds
- Возвращает полную информацию об инструменте (тикер, lot, статус торговли и т.д.)

### 3. `tinvest_api.py` - `get_instrument_by_ticker()`
**Изменения:**
- Добавлена проверка: если входной параметр является FIGI (начинается с "BBG"), автоматически вызывает `get_instrument_by_figi()`
- Теперь поддерживает как тикер, так и FIGI

### 4. `tinvest_api.py` - `get_instrument_details()`
**Изменения:**
- Добавлена проверка на FIGI
- Если входной параметр - FIGI, использует `get_instrument_by_figi()`
- Иначе использует `get_instrument_by_ticker()`

### 5. `tinvest_api.py` - `place_market_order()`
**Изменения:**
- Добавлена поддержка FIGI
- Автоматически определяет тип входного параметра (тикер или FIGI)
- Использует соответствующий метод поиска инструмента

### 6. `tinvest_api.py` - `place_limit_order()`
**Изменения:**
- Добавлена поддержка FIGI (аналогично `place_market_order()`)

### 7. `tinvest_api.py` - `get_historical_data()`
**Изменения:**
- Добавлен поиск по FIGI в дополнение к поиску по тикеру
- Если входной параметр - FIGI, ищет инструмент по FIGI во всех типах
- Иначе использует стандартный поиск по тикеру

### 8. `tinvest_api.py` - `get_current_price()`
**Изменения:**
- Добавлена поддержка FIGI
- Если входной параметр - FIGI, использует `get_current_price_by_figi()` напрямую

### 9. `main.py` - `_ensure_ticker_not_figi()`
**Новая функция-хелпер:**
- Проверяет, является ли `symbol` FIGI
- Если да, пытается найти тикер через API
- Возвращает тикер или исходный `symbol`

### 10. `main.py` - `_execute_buy()`
**Изменения:**
- Использует `_ensure_ticker_not_figi()` перед вызовом `get_instrument_details()`
- Гарантирует, что в API передается тикер, а не FIGI

### 11. `main.py` - `process_symbol()` (SELL логика)
**Изменения:**
- Использует `_ensure_ticker_not_figi()` перед вызовом `get_instrument_details()` и `place_market_order()`
- Гарантирует использование тикера для размещения ордеров

### 12. `main.py` - `check_positions()`
**Изменения:**
- Улучшена логика преобразования FIGI в тикер
- Сначала пытается взять тикер из самой позиции
- Если не найден, использует API для поиска
- При размещении ордеров стоп-лоссов и тейк-профитов использует правильный тикер

### 13. `broker_api.py` - `get_instrument_details()` и `get_instrument_by_figi()`
**Изменения:**
- Обновлены для использования новых методов из `TInvestAPI`
- `get_instrument_details()` теперь поддерживает и тикер, и FIGI

## Покрытие типов инструментов

Все исправления работают для всех типов инструментов из SYMBOLS:

### Акции (27 символов)
- SBER, GAZP, YNDX, VTBR, MOEX, LKOH, ROSN, NVTK, GMKN, TATN, MGNT, AFLT, SNGS, SNGSP, CHMF, NLMK, MAGN, MTSS, IRAO, ALRS, PHOR, PLZL, RUAL, AFKS, TRNFP, SIBN, FLOT, BANE, BANEP, RNFT, TATNP, SELG

### ETF и металлы (2 символа)
- UGLD (золото)
- LNZL (металлы)

### Валюты (7 символов)
- USD000UTSTOM
- CNYRUB_TOM
- GLDRUB_TOM
- SLVRUB_TOM
- PLTRUB_TOM
- PLDRUB_TOM

## Результат

✅ Все функции теперь правильно обрабатывают как тикеры, так и FIGI
✅ Позиции всегда возвращаются с тикером (не FIGI)
✅ При размещении ордеров используется правильный тикер
✅ Ошибки `"Инструмент BBG... не найден"` больше не должны возникать
✅ Поддержка всех типов инструментов: акции, ETF, валюты, облигации

## Тестирование

Рекомендуется протестировать:
1. Открытие позиций по валютным инструментам (PLTRUB_TOM, PLDRUB_TOM)
2. Обработку стоп-лоссов для валютных позиций
3. Обработку тейк-профитов для валютных позиций
4. Обработку позиций по металлам (UGLD)
5. Обработку позиций по акциям (должна работать как раньше)



## Проблема
Бот получал ошибки `"Инструмент BBGPLTRUBTOM не найден"` при обработке стоп-лоссов для валютных инструментов (PLTRUB_TOM, PLDRUB_TOM). Проблема была в том, что позиции возвращались с FIGI вместо тикера, и функции поиска инструментов не могли их обработать.

## Исправления

### 1. `tinvest_api.py` - `get_positions()`
**Изменения:**
- Расширен маппинг `figi_to_meta` для всех типов инструментов:
  - Акции (shares)
  - ETF (включая валютные и металлы)
  - Валюты (currencies)
  - Облигации (bonds)
- Добавлен поиск тикера через API для всех типов, если тикер не найден в `figi_to_meta`
- Исправлен вложенный контекст клиента (используется текущий `client` вместо создания нового)

**Результат:** Позиции теперь всегда возвращаются с тикером, а не FIGI.

### 2. `tinvest_api.py` - `get_instrument_by_figi()`
**Новая функция:**
- Ищет инструмент по FIGI во всех типах: currencies, ETFs, shares, bonds
- Возвращает полную информацию об инструменте (тикер, lot, статус торговли и т.д.)

### 3. `tinvest_api.py` - `get_instrument_by_ticker()`
**Изменения:**
- Добавлена проверка: если входной параметр является FIGI (начинается с "BBG"), автоматически вызывает `get_instrument_by_figi()`
- Теперь поддерживает как тикер, так и FIGI

### 4. `tinvest_api.py` - `get_instrument_details()`
**Изменения:**
- Добавлена проверка на FIGI
- Если входной параметр - FIGI, использует `get_instrument_by_figi()`
- Иначе использует `get_instrument_by_ticker()`

### 5. `tinvest_api.py` - `place_market_order()`
**Изменения:**
- Добавлена поддержка FIGI
- Автоматически определяет тип входного параметра (тикер или FIGI)
- Использует соответствующий метод поиска инструмента

### 6. `tinvest_api.py` - `place_limit_order()`
**Изменения:**
- Добавлена поддержка FIGI (аналогично `place_market_order()`)

### 7. `tinvest_api.py` - `get_historical_data()`
**Изменения:**
- Добавлен поиск по FIGI в дополнение к поиску по тикеру
- Если входной параметр - FIGI, ищет инструмент по FIGI во всех типах
- Иначе использует стандартный поиск по тикеру

### 8. `tinvest_api.py` - `get_current_price()`
**Изменения:**
- Добавлена поддержка FIGI
- Если входной параметр - FIGI, использует `get_current_price_by_figi()` напрямую

### 9. `main.py` - `_ensure_ticker_not_figi()`
**Новая функция-хелпер:**
- Проверяет, является ли `symbol` FIGI
- Если да, пытается найти тикер через API
- Возвращает тикер или исходный `symbol`

### 10. `main.py` - `_execute_buy()`
**Изменения:**
- Использует `_ensure_ticker_not_figi()` перед вызовом `get_instrument_details()`
- Гарантирует, что в API передается тикер, а не FIGI

### 11. `main.py` - `process_symbol()` (SELL логика)
**Изменения:**
- Использует `_ensure_ticker_not_figi()` перед вызовом `get_instrument_details()` и `place_market_order()`
- Гарантирует использование тикера для размещения ордеров

### 12. `main.py` - `check_positions()`
**Изменения:**
- Улучшена логика преобразования FIGI в тикер
- Сначала пытается взять тикер из самой позиции
- Если не найден, использует API для поиска
- При размещении ордеров стоп-лоссов и тейк-профитов использует правильный тикер

### 13. `broker_api.py` - `get_instrument_details()` и `get_instrument_by_figi()`
**Изменения:**
- Обновлены для использования новых методов из `TInvestAPI`
- `get_instrument_details()` теперь поддерживает и тикер, и FIGI

## Покрытие типов инструментов

Все исправления работают для всех типов инструментов из SYMBOLS:

### Акции (27 символов)
- SBER, GAZP, YNDX, VTBR, MOEX, LKOH, ROSN, NVTK, GMKN, TATN, MGNT, AFLT, SNGS, SNGSP, CHMF, NLMK, MAGN, MTSS, IRAO, ALRS, PHOR, PLZL, RUAL, AFKS, TRNFP, SIBN, FLOT, BANE, BANEP, RNFT, TATNP, SELG

### ETF и металлы (2 символа)
- UGLD (золото)
- LNZL (металлы)

### Валюты (7 символов)
- USD000UTSTOM
- CNYRUB_TOM
- GLDRUB_TOM
- SLVRUB_TOM
- PLTRUB_TOM
- PLDRUB_TOM

## Результат

✅ Все функции теперь правильно обрабатывают как тикеры, так и FIGI
✅ Позиции всегда возвращаются с тикером (не FIGI)
✅ При размещении ордеров используется правильный тикер
✅ Ошибки `"Инструмент BBG... не найден"` больше не должны возникать
✅ Поддержка всех типов инструментов: акции, ETF, валюты, облигации

## Тестирование

Рекомендуется протестировать:
1. Открытие позиций по валютным инструментам (PLTRUB_TOM, PLDRUB_TOM)
2. Обработку стоп-лоссов для валютных позиций
3. Обработку тейк-профитов для валютных позиций
4. Обработку позиций по металлам (UGLD)
5. Обработку позиций по акциям (должна работать как раньше)





