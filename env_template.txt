# ============================================
# КОНФИГУРАЦИЯ ТОРГОВОГО БОТА
# ============================================
# Скопируйте этот файл в .env и заполните реальными значениями
# Или переименуйте этот файл в .env и заполните

# ============================================
# TELEGRAM НАСТРОЙКИ
# ============================================
# Получите токен у @BotFather в Telegram
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# Получите Chat ID через @userinfobot в Telegram
TELEGRAM_CHAT_ID=your_telegram_chat_id_here

# ============================================
# T-INVEST API НАСТРОЙКИ (Т-ИНВЕСТИЦИИ)
# ============================================
# Получите токен в настройках Т-Инвестиций
TINVEST_TOKEN=your_tinvest_token_here

# Использовать песочницу (true) или продакшн (false)
TINVEST_SANDBOX=true

# ID счета (опционально, оставьте пустым если один счет)
TINVEST_ACCOUNT_ID=

# (Опционально) gRPC target для песочницы. Обычно не нужен.
# Используйте, если возникают DNS ошибки/поменялся домен.
# Пример: TINVEST_GRPC_TARGET=sandbox-invest-public-api.tbank.ru:443
TINVEST_GRPC_TARGET=

# (Опционально) Автопополнение песочницы при старте (RUB). Если пусто — не пополняем.
# Пример: SANDBOX_PAY_IN_RUB=100000
# Автопополнение песочницы (ОСТОРОЖНО): SandboxPayIn увеличивает баланс и “портит” дневную статистику,
# если вы считаете прибыль/просадку по equity. Рекомендуемо держать выключенным.
# Включайте только когда создаёте НОВЫЙ sandbox-счёт и хотите стартовый баланс.
# SANDBOX_PAY_IN_RUB=100000
SANDBOX_PAY_IN_RUB=0

# Выбор брокера: tinvest
BROKER=tinvest

# ============================================
# ТОРГОВЫЕ НАСТРОЙКИ
# ============================================
# Список акций для торговли (российские для T-Invest)
# Минимум 10 акций (пример для РФ). Можно менять под свои предпочтения.
# ВАЖНО: список зависит от доступности инструментов у вашего брокера.
# База ликвидных акций РФ + доп. “сырьевые” (нефть/металлы) + валютные инструменты/ETF
# ВАЖНО: часть тикеров может быть недоступна для торговли в конкретный момент (сессия/песочница),
# бот пропустит их с причиной instrument_not_tradeable.
SYMBOLS=SBER,GAZP,YNDX,VTBR,MOEX,LKOH,ROSN,NVTK,GMKN,TATN,MGNT,AFLT,SNGS,SNGSP,CHMF,NLMK,MAGN,MTSS,IRAO,ALRS,PHOR,PLZL,RUAL,AFKS,TRNFP,SIBN,FLOT,BANE,BANEP,RNFT,TATNP,SELG,UGLD,LNZL,USD000UTSTOM,CNYRUB_TOM,GLDRUB_TOM,SLVRUB_TOM,PLTRUB_TOM,PLDRUB_TOM

# Начальный капитал
INITIAL_CAPITAL=10000

# Максимальный размер позиции (0.20 = 20%)
MAX_POSITION_SIZE=0.20

# Стоп-лосс (0.03 = 3%)
STOP_LOSS_PERCENT=0.03

# Тейк-профит (0.06 = 6%)
TAKE_PROFIT_PERCENT=0.06

# ============================================
# НАСТРОЙКИ СТРАТЕГИИ
# ============================================
RSI_PERIOD=14
RSI_OVERSOLD=30
RSI_OVERBOUGHT=70
MA_SHORT_PERIOD=20
MA_LONG_PERIOD=50
MACD_FAST=12
MACD_SLOW=26
MACD_SIGNAL=9

# ============================================
# НАСТРОЙКИ ОБНОВЛЕНИЯ
# ============================================
# Интервал обновления в секундах (300 = 5 минут)
UPDATE_INTERVAL=300

# Включить реальную торговлю (true) или только симуляцию (false)
ENABLE_TRADING=true

# Append-only аудит-лог сделок (JSONL). Файл не перезаписывается приложением.
AUDIT_LOG_PATH=audit_logs/trades_audit.jsonl
# Excel-friendly аудит-лог (CSV). Файл не перезаписывается приложением.
AUDIT_CSV_PATH=audit_logs/trades_audit.csv

# ============================================
# LIVE / ПЕСОЧНИЦА (реальное время)
# ============================================
# Интервал свечей для стратегии и глубина истории на каждый цикл
BAR_INTERVAL=15m
HISTORY_LOOKBACK=10d
# Порог уверенности (чем ниже — тем больше сделок, но выше риск/шум)
# ОПТИМИЗИРОВАНО (2026-01-17): снижено до 0.45 для достижения 10+ сделок в день
MIN_CONF_BUY=0.45
MIN_CONF_SELL=0.50
# Для SELL по сигналу можно включить "жёстче", чтобы меньше пилить позицию и платить комиссии
MIN_CONF_SELL_STRONG=0.65
SELL_CONFIRM_BARS=2
# Глобальные фильтры качества BUY (для режима "меньше сделок, выше шанс плюса")
REQUIRE_TREND_UP_BUY=false
MIN_VOLUME_RATIO_BUY=0.0
REQUIRE_MACD_RISING_BUY=false
# Лимит сделок в день (чтобы не разгонять риск и комиссии)
# ОПТИМИЗИРОВАНО (2026-01-17): увеличено до 50 для достижения 10+ сделок в день
MAX_TRADES_PER_DAY=50
DAILY_LOSS_LIMIT_PCT=0.02
# ОПТИМИЗИРОВАНО (2026-01-17): увеличено до 10 для достижения 10+ сделок в день
MAX_OPEN_POSITIONS=10
# ОПТИМИЗИРОВАНО (2026-01-17): снижено до 10 минут для большей активности
SYMBOL_COOLDOWN_MIN=10
AUTO_START=true

# Если внутри дня equity "скачет" слишком сильно (например, из-за sandbox_pay_in),
# дневную базу/просадку корректнее считать ПОСЛЕ последнего такого скачка.
DAILY_CASHFLOW_JUMP_PCT=30%

# Как считать "день" для метрик (Поднятие/Просадка) и дневных лимитов.
# Для MOEX обычно удобнее считать от открытия торгов (10:00 МСК), а не от 00:00.
DAILY_RESET_HOUR_LOCAL=10

# Доп. защита: отключать новые BUY, если просадка от дневного ПИКА превышает порог.
# 0 = выключено (будет работать только DAILY_LOSS_LIMIT_PCT от старта).
DAILY_PEAK_DRAWDOWN_LIMIT_PCT=5%

# После рестарта in-memory трекинг стоп/тейк сбрасывается.
# Включите, чтобы бот восстанавливал entry/stop/take по текущим позициям и audit-логу.
RESTORE_TRACKING_FROM_AUDIT=true

# Перевод стопа в безубыток (опционально):
# когда позиция ушла в плюс на N%, подтягиваем стоп до entry+(lock%).
BREAKEVEN_TRIGGER_PCT=0
BREAKEVEN_LOCK_PCT=0

# Live: sizing/стопы (рекомендовано для контроля риска)
# LIVE_POSITION_SIZING=risk — размер позиции от риска (RISK_PER_TRADE) и расстояния до стопа (ATR/процент).
LIVE_POSITION_SIZING=risk
ATR_STOP_MULT=2.0
ATR_TAKE_MULT=3.0
ATR_TRAIL_MULT=2.0
# Минимальная дистанция для ATR-трейлинга (защита от слишком плотного стопа на маленьком ATR)
TRAIL_MIN_PCT=0.75%
# Минимальный тейк-профит (чтобы TP не был слишком близко и не проигрывал комиссиям/спреду)
TAKE_MIN_PCT=0.75%

# ============================================
# ЗАЩИТА ОТ РИСКОВ НА НИЗКОВОЛАТИЛЬНЫХ И ВЫСОКОЛОТНЫХ ИНСТРУМЕНТАХ
# ============================================
# Мин. ATR как % от цены. Если ATR/price < этого значения — не входим.
# Защита от инструментов типа UGLD с крошечным ATR (был убыток -466 RUB из-за "шумового" стопа).
MIN_ATR_PCT=0.4%
# Минимальная дистанция стопа от входа (защита от слишком плотных стопов)
MIN_STOP_DISTANCE_PCT=1.2%
# Порог "высокого лота" (UGLD lot=1000, акция стоит ~0.58, лот=580 RUB)
HIGH_LOT_THRESHOLD=100
# Коэффициент уменьшения размера для высоколотных инструментов (0.5 = половина от расчётного)
HIGH_LOT_SIZE_FACTOR=0.5
# Жёсткий лимит на СТОИМОСТЬ одной позиции (% от equity, ПОСЛЕ округления до лотов)
MAX_POSITION_VALUE_PCT=20%
# RSI порог "сильной перекупленности" — если RSI > этого, SELL идёт без ожидания SELL_CONFIRM_BARS
# Успешный паттерн: лучшие SELL были при RSI > 75-85.
RSI_STRONG_OVERBOUGHT=80

# ============================================
# ФИЛЬТРЫ КАЧЕСТВА BUY (по анализу ошибок 2026-01-14)
# ============================================
# Анализ показал: ВСЕ убыточные BUY имели отрицательный MACD_hist (падающий импульс).
# При этом RSI > 65 опасен для BUY (если нет сильного положительного импульса).

# Максимальный RSI для BUY. ИСПРАВЛЕНО (2026-01-15): увеличено до 68
# ОПТИМИЗИРОВАНО (2026-01-17): увеличено до 75 для достижения 10+ сделок в день
RSI_MAX_BUY=75
# Блокируем BUY при sideways + отрицательный MACD (опасная комбинация: RUAL -97₽, PLDRUB открыта).
BLOCK_SIDEWAYS_NEGATIVE_MACD=true
# Требовать СТРОГО положительный MACD_hist (консервативно, по умолчанию выключено).
REQUIRE_MACD_HIST_POSITIVE_BUY=false
# Мин. ratio macd_hist/atr. ИСПРАВЛЕНО (2026-01-15): снижено до -0.15
# ОПТИМИЗИРОВАНО (2026-01-17): снижено до -0.4 для достижения 10+ сделок в день
MIN_MACD_HIST_ATR_RATIO_BUY=-0.4
# При RSI > RSI_MAX_BUY разрешаем BUY если macd_hist/atr >= этого. ИСПРАВЛЕНО: снижено до 0.3
MACD_OVERRIDE_FOR_HIGH_RSI=0.3

# ============================================
# ГЛОБАЛЬНЫЕ МОДУЛИ ПОВЫШЕНИЯ ДОХОДНОСТИ
# ============================================
# Эти модули работают автоматически и повышают прибыльность за счёт:
# 1. Адаптации к историческому перформансу символов
# 2. Защиты от коррелированных позиций (не держать много нефтегаза одновременно)
# 3. Адаптации к режиму рынка (бычий/медвежий/боковой)
# 4. Фильтрации по оптимальным торговым часам

# Symbol Tracker: адаптивный трекинг производительности символов
# Автоматически уменьшает размер позиции для "холодных" символов с плохой историей
# и увеличивает для "горячих" символов на победной серии.
ENABLE_SYMBOL_TRACKER=true
SYMBOL_TRACKER_STATE_PATH=state/symbol_performance.json
SYMBOL_TRACKER_LOOKBACK_DAYS=14

# Market Regime: детектор режима рынка (BULL/BEAR/SIDEWAYS)
# В бычьем рынке — агрессивнее покупаем, в медвежьем — осторожнее.
ENABLE_MARKET_REGIME=true

# Correlation Guard: защита от коррелированных позиций
# Не открывает несколько позиций в одном секторе (нефтегаз, металлы, финансы и т.д.)
ENABLE_CORRELATION_GUARD=true
# Максимум позиций в одной коррелированной группе
MAX_POSITIONS_PER_CORRELATION_GROUP=2

# Time Filter: фильтр оптимальных торговых часов на MOEX
# Оптимальные часы: 10-12 и 15-18 MSK
# Рискованные часы: 9-10 (открытие) и 18-19 (закрытие)
ENABLE_TIME_FILTER=false
# Блокировать торговлю в рискованные часы (первый/последний час сессии)
BLOCK_RISKY_HOURS=false

# Автоматическая блокировка символов с плохой статистикой
# Если символ имеет loss_rate > AUTO_BLOCK_MAX_LOSS_RATE за последние AUTO_BLOCK_MIN_TRADES сделок,
# он автоматически блокируется для новых покупок.
AUTO_BLOCK_BAD_SYMBOLS=false
AUTO_BLOCK_MIN_TRADES=5
AUTO_BLOCK_MAX_LOSS_RATE=0.75

# Recommendation D: фильтр качества входа для шумных/дешёвых бумаг
# По вашему 3-дневному отчёту основные stop_loss пришлись на LKOH/GMKN/MGNT, поэтому
# по умолчанию применяем фильтр к ним и VTBR.
# После анализа 2026-01-14: добавлен UGLD (большие лоты, маленький ATR, частые стопы).
NOISY_SYMBOLS=VTBR,LKOH,GMKN,MGNT,UGLD
# Для шумных бумаг разрешаем BUY только в up-тренде
NOISY_REQUIRE_TREND_UP=true
# Требуем подтверждение объёмом (volume / volume_ma)
NOISY_VOLUME_RATIO_MIN=1.2
# Требуем положительный MACD histogram (импульс >= 0)
NOISY_MACD_HIST_MIN=0.0
# Требуем, чтобы импульс улучшался (macd_hist >= macd_hist_prev)
NOISY_REQUIRE_MACD_RISING=true
# Для шумных бумаг повышаем порог уверенности на BUY
NOISY_MIN_CONF_BUY=0.70

# Ранжирование кандидатов BUY: сколько лучших входов делать за один цикл
# ОПТИМИЗИРОВАНО (2026-01-17): увеличено до 5 для достижения 10+ сделок в день
MAX_BUYS_PER_CYCLE=5

# Расширенное audit-логирование (для последующей оптимизации стратегии по данным за неделю)
AUDIT_DECISIONS=true
AUDIT_MARKET=true
AUDIT_DECISION_EVERY_N=1

# ============================================
# BACKTEST / ИСТОРИЧЕСКИЕ ДАННЫЕ
# ============================================
# Период бэктеста: 2024 | 1y | 2y | 3y | all
BACKTEST_PERIOD=all

# Стратегия для бэктеста: hybrid | trend | mean | ensemble | all | best
BACKTEST_STRATEGY=best

# Cooldown после stop_loss (в днях баров) для борьбы с "пилой"
COOLDOWN_DAYS=10

# Кэш исторических данных (чтобы не скачивать каждый раз)
DATA_CACHE_DIR=data_cache
# Принудительно перекачать данные (true/false)
CACHE_REFRESH=false

# Риск на одну сделку (доля капитала). Рекомендуемо 0.003..0.01
RISK_PER_TRADE=0.005

# Если риск-позиционирование даёт qty=0 (широкий ATR-стоп), в бэктесте можно разрешить
# вход "минимальным объёмом" (1 акция) при высокой уверенности.
ALLOW_MIN_QTY=true
MIN_CONFIDENCE_FOR_MIN_QTY=0.75

# Множители ATR для стопа/тейка/трейлинга в бэктесте
ATR_STOP_MULT=2.0
ATR_TAKE_MULT=3.0
ATR_TRAIL_MULT=2.0

# BEST-режим: минимальное число сделок, чтобы стратегия считалась "валидной" для выбора
# (0 = разрешить выбирать стратегии с 0 сделок)
BEST_MIN_TRADES=1


